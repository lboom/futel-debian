[general]
clearglobalvars=no

[globals]
TRUNK=DAHDI/G2
crossclinton_extension=610
ypsi_extension=630
mykle_extension=640
iprc_extension=650
garth_extension=655
oskar_in_extension=667
oskar_extension=668
r2d2_extension=670
xnor_extension=680
demo_extension=700
r2d2_incoming=19149775129
twilio_oskar_in_incoming=+15034448759
twilio_stage_oskar_in_incoming=+15036163619
twilio_oskar_incoming=+15039465227
twilio_garth_incoming=+15039266271
twilio_xnor_incoming=+15034449412
twilio_ypsi_incoming=+17345476651
twilio_mykle_incoming=+15039288465
twilio_crossclinton_incoming=+19712666851
; this number is in use, but the variable is not
;voipms_leet_incoming=5034681337
max_iterations=10

[macro-say]
; first arg is name of statement file, rest are preferred subdirs,
; ignored if empty
exten => s,1,AGI(sound_path.agi,${ARG1},${MACRO_CONTEXT},${ARG2})
same => n,Background(${agi_out})

[macro-metric]
exten => s,1,AGI(metric.agi,${ARG1})

; dial number with timeout if it passes filter
[macro-filterdial]
exten => s,1,Macro(metric,macro-filterdial)
; filter or die
same => n,AGI(filter_outgoing.agi,${ARG1})
; friction, which may or may not die
same => n,AGI(friction.agi,filterdial)
; we passed, find timeout, if any, and dial
same => n,AGI(call_timeout.agi)
same => n,Macro(dial,${ARG1},${agi_out})

; dial number given by ARG1
; with timeout given by ARG2 in dial command syntax (which can be empty)
[macro-dial]
exten => s,1,Macro(metric,macro-dial)
; wait for ratelimiter
same => n,AGI(call_ratelimit.agi)
; start trying to dial
same => n,Dial(SIP/${ARG1}@${outgoingchannel},,g${ARG2})
same => n,Goto(s,${DIALSTATUS})
; unsuccessful, try again
same => n(CHANUNAVAIL),NoOp
same => n(CONGESTION),NoOp
same => n,Macro(dial-tryagain,${ARG1},${ARG2})
; successful, fall through
same => n(ANSWER),NoOp
same => n(NOANSWER),NoOp
same => n(BUSY),NoOp
same => n(CANCEL),NoOp
same => n,Macro(metric,outgoing-dialstatus-${DIALSTATUS}-${outgoingchannel})
same => n,Hangup

; dial number given by ARG1
; with timeout given by ARG2 in dial command syntax (which can be empty)
[macro-dial-tryagain]
exten => s,1,Macro(metric,macro-dial-tryagain)
same => n,Wait(2)
same => n,AGI(random_file.agi,/usr/share/asterisk/sounds/futel/oracle-dead-interstitial-short)
same => n,Playback(${agi_out})
; wait for ratelimiter
same => n,AGI(call_ratelimit.agi)
; start trying to dial
same => n,Dial(SIP/${ARG1}@${outgoingchannel},,g${ARG2})
same => n,Macro(metric,outgoing-dialstatus-${DIALSTATUS}-${outgoingchannel})
same => n,Goto(s,${DIALSTATUS})
; unsuccessful
same => n(CHANUNAVAIL),NoOp
same => n(CONGESTION),NoOp
same => n,Playtones(congestion) 
same => n,Congestion
; successful, fall through
same => n(ANSWER),NoOp
same => n(NOANSWER),NoOp
same => n(BUSY),NoOp
same => n(CANCEL),NoOp
same => n,Hangup

[macro-setup-iteration]
exten => s,1,Set(context_iterator=0)

; increment iterator, hangup if iterator is too large, otherwise return
[macro-iterate-guard]
exten => s,1,Set(context_iterator=$[ ${context_iterator} + 1 ])
same => n,GotoIf($[ ${context_iterator} > ${max_iterations} ]?hangup)
same => n,MacroExit
same => n(hangup),Macro(say,goodbye)
same => n,Hangup

; extension to start incoming call
[default-incoming]
exten => _!,1,Macro(metric,default-incoming)
; set variable to the number called, which is in SIP_HEADER(To)
same => n,Set(caller=${CUT(CUT(SIP_HEADER(To),@,1),:,2)})
same => n,Goto(incoming-route-by-caller,s,1)

[incoming-route-by-caller]
; route to appropriate context based on call origin
exten => s,1,NoOp
same => n,gotoIf($["${caller}" = "${twilio_oskar_incoming}"]?ring-oskar,s,1)
same => n,gotoIf($["${caller}" = "${r2d2_incoming}"]?ring-r2d2,s,1)
same => n,gotoIf($["${caller}" = "${twilio_oskar_in_incoming}"]?ring-oskar-in,s,1)
same => n,gotoIf($["${caller}" = "${twilio_stage_oskar_in_incoming}"]?ring-oskar-in,s,1)
same => n,gotoIf($["${caller}" = "${twilio_garth_incoming}"]?ring-garth,s,1)
same => n,gotoIf($["${caller}" = "${twilio_xnor_incoming}"]?ring-xnor,s,1)
same => n,gotoIf($["${caller}" = "${twilio_ypsi_incoming}"]?ring-ypsi,s,1)
same => n,gotoIf($["${caller}" = "${twilio_crossclinton_incoming}"]?ring-crossclinton,s,1)
same => n,gotoIf($["${caller}" = "${twilio_mykle_incoming}"]?ring-mykle,s,1)
; fallback, go to the incoming menu
same => n,Goto(incoming-ivr,s,1)

[ring-oskar]
exten => s,1,Macro(metric,ring-oskar)
same => n,Dial(SIP/${oskar_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-oskar)

[ring-r2d2]
exten => s,1,Macro(metric,ring-r2d2)
same => n,Dial(SIP/${r2d2_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-r2d2)

[ring-oskar-in]
exten => s,1,Macro(metric,ring-oskar-in)
same => n,Dial(SIP/${oskar_in_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-oskarin)

[ring-xnor]
exten => s,1,Macro(metric,ring-xnor)
same => n,Dial(SIP/${xnor_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-xnor)

[ring-garth]
exten => s,1,Macro(metric,ring-garth)
same => n,Dial(SIP/${garth_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-garth)

[ring-ypsi]
exten => s,1,Macro(metric,ring-ypsi)
same => n,Dial(SIP/${ypsi_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-ypsi)

[ring-crossclinton]
exten => s,1,Macro(metric,ring-crossclinton)
same => n,Dial(SIP/${crossclinton_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-crossclinton)

[ring-mykle]
exten => s,1,Macro(metric,ring-mykle)
same => n,Dial(SIP/${mykle_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-mykle)

[ring-demo]
exten => s,1,Macro(metric,ring-demo)
same => n,Dial(SIP/${demo_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-demo)

[incoming-ivr]
exten => s,1,Macro(metric,incoming-ivr)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,Answer(500)       ; is this necessary?
same => n,WaitExten(0.1)
same => n,Macro(say,welcome-to-fewtel)
same => n,Macro(say,for-voicemail)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-fewtel-community)
same => n,Macro(say,press-two)
same => n,Macro(say,to-speak-to-an-operator)
same => n,Macro(say,press-zero)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Gosub(incoming-voicemail,s,1)
same => n,Goto(s,postsetup)
exten => 2,1,Gosub(community-ivr,s,1)
same => n,Goto(s,postsetup)
; secret admin menu
exten => 8,1,Gosub(admin-auth,s,1)
same => n,Goto(s,postsetup)
; secret fake admin menu
exten => 9,1,Gosub(incoming-fake-admin-auth,s,1)
same => n,Goto(s,postsetup)
exten => 0,1,VoiceMail(1337,u)
exten => i,1,Goto(s,postsetup)

[futel-information]
exten => s,1,Macro(metric,futel-information)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Macro(say,fewtel)
same => n,Macro(say,is)
same => n,Macro(say,portlands-most-exclusive-telephone-network)
same => n,Macro(say,providing)
same => n,Macro(say,telephony)
same => n,Macro(say,and)
same => n,Macro(say,voicemail)
same => n,Macro(say,and)
same => n,Macro(say,human)
same => n,Macro(say,and)
same => n,Macro(say,machine)
same => n,Macro(say,interaction)
same => n,WaitExten(0.25)
same => n,Macro(say,all-services-are-free)
same => n,Macro(say,from-any-fewtel-phone)
same => n,WaitExten(0.25)
same => n,Macro(say,for-more-information)
same => n,Macro(say,contact-the-operator)
same => n,Macro(say,from-any-fewtel-phone)
same => n,Macro(say,or)
same => n,Macro(say,visit-our-website)
same => n,Macro(say,at)
same => n,Macro(say,fewtel-dot-net)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[admin-auth]
    exten => s,1,Macro(metric,admin-auth)
    same => n,Macro(setup-iteration)    
    same => n(postsetup),NoOp
    same => n,Macro(iterate-guard)    
    same => n,Authenticate(${admin_password})
    same => n,Wait(0.25)    ;avoid digits leaking into next menu
    same => n,Goto(admin-ivr,s,1)

[incoming-fake-admin-auth]
    exten => s,1,Macro(metric,incoming-fake-admin-auth)
    same => n,Macro(setup-iteration)    
    same => n(postsetup),NoOp
    same => n,Macro(iterate-guard)    
    same => n,Authenticate(592751)
    same => n,Wait(0.25)    ;avoid digits leaking into next menu
    same => n,Hangup

; extension to start outgoing call
[default-outgoing]
; We can't do much here, because our sip clients go directly to the
; extension, so we go to a context that can.
; Specific extensions go to outgoing-by-destination, but these are
; generally for testing, we get more control with
; outgoing-by-calling-extension.
exten => 994,1,Set(destination=outgoing-ivr-ypsi)
same => n,Goto(outgoing-by-destination,s,1)
exten => 995,1,Set(destination=outgoing-ivr)
same => n,Goto(outgoing-by-destination,s,1)
exten => 996,1,Set(destination=restricted-outgoing-dialtone-wrapper)
same => n,Goto(outgoing-by-destination,s,1)
exten => 997,1,Set(destination=oracle-dead)
same => n,Goto(outgoing-by-destination,s,1)
exten => 998,1,Set(destination=admin-ivr)
same => n,Goto(outgoing-by-destination,s,1)
; 999 used by public phones
exten => 999,1,Goto(outgoing-by-calling-extension,s,1)
; 1000 used by r2d2, obsolete?
exten => 1000,1,Set(destination=outgoing-dialtone-wrapper)
same => n,Goto(outgoing-by-destination,s,1)
; 1001 used by incoming line
exten => 1001,1,Set(destination=incoming-ivr)
same => n,Goto(outgoing-by-destination,s,1)

[outgoing-by-destination]
; go to a destination determined by a variable value
exten => s,1,Macro(metric,outgoing-by-destination)
same => n,Set(CALLERID(num)=${callerid})
same => n,Goto(${destination},s,1)

[outgoing-by-calling-extension]
exten => s,1,Macro(metric,outgoing-by-calling-extension)
same => n,Set(CALLERID(num)=${callerid})
; crossclinton
same => n,gotoIf($[ ${calling_extension} = 610 ]?outgoing-dialtone-wrapper,s,1)
same => n,gotoIf($[ ${calling_extension} = 611 ]?outgoing-ivr,s,1)
; ypsi
same => n,gotoIf($[ ${calling_extension} = 630 ]?outgoing-ivr-ypsi,s,1)
; mykle
same => n,gotoIf($[ ${calling_extension} = 640 ]?outgoing-ivr,s,1)
; taylor
same => n,gotoIf($[ ${calling_extension} = 655 ]?outgoing-ivr,s,1)
; oskar
same => n,gotoIf($[ ${calling_extension} = 667 ]?outgoing-ivr,s,1)
same => n,gotoIf($[ ${calling_extension} = 668 ]?outgoing-ivr,s,1)
same => n,gotoIf($[ ${calling_extension} = 669 ]?outgoing-ivr,s,1)
; r2d2
same => n,gotoIf($[ ${calling_extension} = 670 ]?outgoing-dialtone-wrapper,s,1)
; xnor
same => n,gotoIf($[ ${calling_extension} = 680 ]?outgoing-ivr,s,1)
; default goes to the incoming ivr, since it's the safest
same => n,Goto(incoming-ivr,s,1)

[outgoing-ivr]
exten => s,1,Macro(metric,outgoing-ivr)
same => n,Macro(setup-iteration)
same => n,AGI(random_file.agi,/usr/share/asterisk/sounds/futel/oracle-dead-interstitial-short)
same => n,Playback(${agi_out})
same => n,AGI(friction.agi,outgoing-ivr)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Macro(say,fewtel)
same => n,Macro(say,to-make-a-call)
same => n,Macro(say,press-one)
same => n,Macro(say,for-voicemail)
same => n,Macro(say,press-two)
same => n,Macro(say,for-the-directory)
same => n,Macro(say,press-three)
same => n,Macro(say,for-utilities)
same => n,Macro(say,press-four)
same => n,Macro(say,for-the-fewtel-community)
same => n,Macro(say,press-five)
same => n,Macro(say,for-community-services)
same => n,Macro(say,press-six)
same => n,Macro(say,for-the-telecommunications-network)
same => n,Macro(say,press-seven)
; rotating arbitrary featured option
same => n,Macro(say,for-the-wildcard-line)
same => n,Macro(say,press-eight)
same => n,Macro(say,for-the-operator)
same => n,Macro(say,press-zero)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(outgoing-dialtone-wrapper,s,1)
exten => 2,1,Gosub(outgoing-voicemail,s,1)
same => n,Goto(s,postsetup)
exten => 3,1,Gosub(directory-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 4,1,Gosub(utilities-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 5,1,Gosub(community-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 6,1,Gosub(community-services-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 7,1,Gosub(network-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 8,1,Gosub(wildcard-line-outgoing,s,1)
same => n,Goto(s,postsetup)
exten => 9,1,Goto(911-9,s,1)
exten => 0,1,Goto(operator,s,1)
; secret menu option! Pound gets internal dialtone
exten => #,1,Goto(internal-dialtone-wrapper,s,1)
exten => i,1,Goto(s,postsetup)

[outgoing-ivr-ypsi]
exten => s,1,Macro(metric,outgoing-ivr-ypsi)
same => n,Macro(setup-iteration)
same => n,AGI(random_file.agi,/usr/share/asterisk/sounds/futel/oracle-dead-interstitial-short)
same => n,Playback(${agi_out})
same => n,AGI(friction.agi,outgoing-ivr-ypsi)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Macro(say,fewtel)
same => n,Macro(say,to-make-a-call)
same => n,Macro(say,press-one)
same => n,Macro(say,for-voicemail)
same => n,Macro(say,press-two)
same => n,Macro(say,for-the-directory)
same => n,Macro(say,press-three)
same => n,Macro(say,for-utilities)
same => n,Macro(say,press-four)
same => n,Macro(say,for-the-fewtel-community)
same => n,Macro(say,press-five)
same => n,Macro(say,for-the-telecommunications-network)
same => n,Macro(say,press-seven)
; rotating arbitrary featured option
same => n,Macro(say,for-the-wildcard-line)
same => n,Macro(say,press-eight)
same => n,Macro(say,for-the-operator)
same => n,Macro(say,press-zero)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(outgoing-dialtone-wrapper,s,1)
exten => 2,1,Gosub(outgoing-voicemail,s,1)
same => n,Goto(s,postsetup)
exten => 3,1,Gosub(directory-ivr-ypsi,s,1)
same => n,Goto(s,postsetup)
exten => 4,1,Gosub(utilities-ivr-ypsi,s,1)
same => n,Goto(s,postsetup)
exten => 5,1,Gosub(community-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 7,1,Gosub(network-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 8,1,Gosub(wildcard-line-outgoing,s,1)
same => n,Goto(s,postsetup)
exten => 9,1,Goto(911-9,s,1)
exten => 0,1,Goto(operator,s,1)
; secret menu option! Pound gets internal dialtone
exten => #,1,Goto(internal-dialtone-wrapper,s,1)
exten => i,1,Goto(s,postsetup)

; allow 911 from outgoing menu
[911-9]
exten => s,1,Macro(metric,911-9)
same => n,WaitExten(5)
same => n,Busy
exten => 1,1,Gosub(911-91,s,1)
; busy on invalid
exten => i,1,Busy

[911-91]
exten => s,1,Macro(metric,911-91)
same => n,WaitExten(5)
same => n,Busy
exten => 1,1,Gosub(911-911,s,1)
; busy on invalid
exten => i,1,Busy

[911-911]
exten => s,1,Macro(metric,911-911)
same => n(postsetup),NoOp
same => n,Macro(say,dialing-nine-one-one)
same => n,Macro(dial,911)
; on invalid repeat, this at least lets panicky users think about what
; they're doing
exten => i,1,Goto(s,postsetup)

[admin-ivr]
exten => s,1,Macro(metric,admin-ivr)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,fewtel)
same => n,Macro(say,for-the-fewtel-voice-conference)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-outgoing-menu)
same => n,Macro(say,press-two)
same => n,Macro(say,to-record-a-menu)
same => n,Macro(say,press-three)
same => n,Macro(say,for-the-operator)
same => n,Macro(say,press-zero)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(futel-conf,s,1)
same => n,Goto(s,postsetup)
exten => 2,1,Goto(outgoing-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 3,1,Gosub(record,s,1)
same => n,Goto(s,postsetup)
exten => 0,1,Goto(operator,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[outgoing-dialtone-wrapper]
exten => s,1,Macro(metric,outgoing-dialtone-wrapper)
same => n,DISA(no-password,outgoing-dialtone)

[outgoing-dialtone]
exten => _911,1,Macro(dial,${EXTEN})
exten => _211,1,Macro(dial,+18666986155)
; 911 test
exten => _933,1,Macro(dial,${EXTEN})
; voip.ms 911 test, which must be in this format for some reason
exten => _15555550911,1,Macro(dial,${EXTEN})
; information numbers blocked by provider go to operator
exten => _NXX5551212,1,Goto(operator,s,1)
exten => _1NXX5551212,1,Goto(operator,s,1)
; 11 digit prefixed with 1: NANPA e.164, normalize with + prefix
exten => _1XXXXXXXXXX,1,Macro(filterdial,+${EXTEN})
; 10 digit not prefixed with 1 or 0: NANPA, normalize to e.164 with +1 prefix
exten => _NXXXXXXXXX,1,Macro(filterdial,+1${EXTEN})
; 14 digit prefixed with 011 1: NANPA with international and country code,
; normalize to e.164 with + prefix and no international code
exten => _0111XXXXXXXXXX,1,Macro(filterdial,+${EXTEN:3})
; 15 digit prefixed with 011 52: Mexico (no cell?)
; with international and country code,
; normalize to e.164 with + prefix and no international code
exten => _01152XXXXXXXXXX,1,Macro(filterdial,+${EXTEN:3})
; 12 digit prefixed with 52: Mexico (no cell?) e.164, normalize with + prefix
exten => _52XXXXXXXXXX,1,Macro(filterdial,+${EXTEN})
exten => _0,1,Goto(operator,s,1)
exten => _#,1,Goto(outgoing-ivr,s,1)
exten => i,1,Busy               ; on invalid annoy caller

[restricted-outgoing-dialtone-wrapper]
exten => s,1,Macro(metric,restricted-outgoing-dialtone-wrapper)
same => n,DISA(no-password,restricted-outgoing-dialtone)

[restricted-outgoing-dialtone]
exten => _911,1,Macro(dial,${EXTEN})
exten => _211,1,Macro(dial,+18666986155)
; 911 test
exten => _933,1,Macro(dial,${EXTEN})
; voip.ms 911 test, which must be in this format for some reason
exten => _15555550911,1,Macro(dial,${EXTEN})
; operator goes directly to operator voicemail
exten => _0,1,VoiceMail(1337,u)
exten => i,1,Busy               ; on invalid annoy caller

[internal-dialtone-wrapper]
exten => s,1,Macro(metric,internal-dialtone-wrapper)
same => n,DISA(no-password,internal-dialtone)
exten => i,1,Busy               ; on invalid annoy caller

[internal-dialtone]
; dialtone that lets us call selected 3-digit extensions
exten => _650,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-${EXTEN})
exten => _667,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-${EXTEN})
exten => _668,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-${EXTEN})
exten => _680,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-${EXTEN})
exten => _690,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-${EXTEN})
exten => _691,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-${EXTEN})
exten => _7XX,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-${EXTEN})

[followme-operator]
; context to define extensions for op destinations and op actions
exten => 667,1,Dial(SIP/667)
; outgoingcontext variable isn't surviving to here, but we like having specific
; providers so we don't step on dialtone capacity
exten => ${karl_cell},1,Dial(SIP/${karl_cell}@voipms)
exten => ${elijah_cell},1,Dial(SIP/${elijah_cell}@voipms)
exten => ${xnor_cell},1,Dial(SIP/${xnor_cell}@voipms)
exten => ${brandon},1,Dial(SIP/${brandon}@voipms)
exten => ${mathew},1,Dial(SIP/${mathew}@voipms)
exten => ${alma_frankenstein},1,Dial(SIP/${alma_frankenstein}@voipms)
exten => ${emily},1,Dial(SIP/${emily}@voipms)
exten => ${mykle},1,Dial(SIP/${mykle}@voipms)
exten => ${james_downey},1,Dial(SIP/${james_downey}@voipms)
exten => ${will_caruana},1,Dial(SIP/${will_caruana}@voipms)
; allow ops to transfer callers
exten => 995,1,Goto(outgoing-dialtone-wrapper,s,1)
; may need to transfer back to main...
exten => 999,1,Goto(outgoing-ivr,s,1)

[outgoing-voicemail]
exten => s,1,Macro(metric,outgoing-voicemail)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.25)
same => n,Macro(say,to-check-your-voicemail)
same => n,Macro(say,press-one)
same => n,Macro(say,to-create-a-new-voicemail-box)
same => n,Macro(say,press-two)
same => n,Macro(say,to-leave-a-voicemail)
same => n,Macro(say,press-three)
same => n,Macro(say,for-more-information-about-the-fewtel-voicemail-system)
same => n,Macro(say,press-four)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
; check voicemail
exten => 1,1,Macro(metric,voicemail-main)
exten => 1,2,VoiceMailMain()
; create vm
exten => 2,1,Macro(metric,next-vm)
same => n,Macro(say,voicemail)    
same => n,Macro(say,can-be-accessed)
same => n,Macro(say,from-any-fewtel-phone)
same => n,Macro(say,or)
same => n,Macro(say,from-the-fewtel-incoming-line)
same => n,AGI(next_vm.agi)
same => n,system(/usr/sbin/asterisk -x "voicemail reload")
same => n,VoiceMailMain(${vmbox})
; leave voicemail
exten => 3,1,Macro(metric,voicemail)
exten => 3,2,VoiceMail()
; more information about voicemail
exten => 4,1,Gosub(voicemail-information,s,1)
same => n,Goto(s,postsetup)
exten => #,1,Return    
exten => i,1,Goto(s,postsetup)

[incoming-voicemail]
exten => s,1,Macro(metric,incoming-voicemail)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.25)
same => n,Macro(say,to-check-your-voicemail)
same => n,Macro(say,press-one)
same => n,Macro(say,to-leave-a-voicemail)
same => n,Macro(say,press-two)
same => n,Macro(say,for-more-information-about-the-fewtel-voicemail-system)
same => n,Macro(say,press-three)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
; check voicemail
exten => 1,1,Macro(metric,voicemail-main)
exten => 1,2,VoiceMailMain()
; leave voicemail
exten => 2,1,Macro(metric,voicemail)
exten => 2,2,VoiceMail()
; more information about voicemail
exten => 3,1,Gosub(voicemail-information,s,1)
same => n,Goto(s,postsetup)
exten => #,1,Return    
exten => i,1,Goto(s,postsetup)

[voicemail-information]
exten => s,1,Macro(metric,voicemail-information)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.25)
same => n,Macro(say,voicemail-boxes-in-the-fewtel-voicemail-system)
same => n,Macro(say,can-be-created)
same => n,Macro(say,from-any-fewtel-phone)
same => n,Macro(say,voicemail-boxes-in-the-fewtel-voicemail-system)
same => n,Macro(say,can-be-accessed)
same => n,Macro(say,from-any-fewtel-phone)
same => n,Macro(say,or)
same => n,Macro(say,from-the-fewtel-incoming-line)
same => n,Macro(say,at)
same => n,Macro(say,five)
same => n,Macro(say,zero)
same => n,Macro(say,three)
same => n,Macro(say,four)
same => n,Macro(say,six)
same => n,Macro(say,eight)
same => n,Macro(say,one)
same => n,Macro(say,three)
same => n,Macro(say,three)
same => n,Macro(say,seven)
same => n,Macro(say,again)
same => n,Macro(say,at)
same => n,Macro(say,five)
same => n,Macro(say,zero)
same => n,Macro(say,three)
same => n,Macro(say,four)
same => n,Macro(say,six)
same => n,Macro(say,eight)
same => n,Macro(say,one)
same => n,Macro(say,three)
same => n,Macro(say,three)
same => n,Macro(say,seven)
same => n,Goto(s,postsetup)
exten => #,1,Return    
exten => i,1,Goto(s,postsetup)
    
[directory-ivr]
exten => s,1,Macro(metric,directory-ivr)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.25)
same => n,Macro(say,for-the-mayor)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-druid-of-sissyphus-gardens)
same => n,Macro(say,press-two)
same => n,Macro(say,to-apologize)
same => n,Macro(say,press-three)
same => n,Macro(say,for-a-random-payphone)
same => n,Macro(say,press-four)
same => n,Macro(say,for-the-wilamette-valley-dream-survey)
same => n,Macro(say,press-five)
same => n,Macro(say,for-the-office-of-night-things)
same => n,Macro(say,press-six)
same => n,Macro(say,for-beyond-the-echo)
same => n,Macro(say,press-seven)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(mayor-vm,s,1)
exten => 2,1,Goto(lance-e-pants,s,1)
exten => 3,1,Goto(apology-line,s,1)
exten => 4,1,Goto(random-payphone,s,1)
exten => 5,1,Goto(dream-survey,s,1)
exten => 6,1,Goto(office-of-night-things,s,1)
exten => 7,1,Goto(beyond-the-echo,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[directory-ivr-ypsi]
exten => s,1,Macro(metric,directory-ivr-ypsi)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.25)
same => n,Macro(say,for-the-druid-of-sissyphus-gardens)
same => n,Macro(say,press-two)
same => n,Macro(say,to-apologize)
same => n,Macro(say,press-three)
same => n,Macro(say,for-a-random-payphone)
same => n,Macro(say,press-four)
same => n,Macro(say,for-the-office-of-night-things)
same => n,Macro(say,press-five)
same => n,Macro(say,for-beyond-the-echo)
same => n,Macro(say,press-six)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 2,1,Goto(lance-e-pants,s,1)
exten => 3,1,Goto(apology-line,s,1)
exten => 4,1,Goto(random-payphone,s,1)
exten => 5,1,Goto(office-of-night-things,s,1)
exten => 6,1,Goto(beyond-the-echo,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[network-ivr]
exten => s,1,Macro(metric,network-ivr)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.25)
same => n,Macro(say,for-the-collectors-net-inbound-portal)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-mojave-phone-booth-conference-line)
same => n,Macro(say,press-two)
same => n,Macro(say,for-the-dark-fiber)
same => n,Macro(say,press-three)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(cnet-portal,s,1)
exten => 2,1,Goto(mojave-conference,s,1)
exten => 3,1,Goto(dark-fiber,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[community-services-ivr]
exten => s,1,Macro(metric,services-ivr)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-two-one-one-community-resources)
same => n,Macro(say,press-one)
same => n,Macro(say,for-multnomah-county-mental-health-crisis-intervention)
same => n,Macro(say,press-two)
same => n,Macro(say,for-the-call-to-safety-crisis-line)
same => n,Macro(say,press-three)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(info-211,s,1)
exten => 2,1,Goto(mental-health-crisis,s,1)
exten => 3,1,Goto(call-to-safety,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[community-ivr]
exten => s,1,Macro(metric,community-ivr)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-fewtel-voice-conference)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-wildcard-line)
same => n,Macro(say,press-two)
same => n,Macro(say,for-the-church-of-robotron)
same => n,Macro(say,press-three)
same => n,Macro(say,to-ring-the-clinton-street-telephone)
same => n,Macro(say,press-four)
same => n,Macro(say,to-ring-the-ainsworth-street-telephone)
same => n,Macro(say,press-five)
same => n,Macro(say,to-ring-the-taylor-street-telephone)
same => n,Macro(say,press-six)
same => n,Macro(say,for-more-information-about-fewtel)
same => n,Macro(say,press-seven)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(futel-conf,s,1)
exten => 2,1,Gosub(wildcard-line-outgoing,s,1)
exten => 3,1,Gosub(robotron,s,1)    
exten => 4,1,Goto(ring-oskar,s,1)
exten => 5,1,Goto(ring-xnor,s,1)
exten => 6,1,Goto(ring-garth,s,1)
exten => 7,1,Gosub(futel-information,s,1)
same => n,Goto(s,postsetup)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[utilities-ivr]
exten => s,1,Macro(metric,utilities-ivr)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-current-time)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-trymet-transit-tracker)
same => n,Macro(say,press-two)
same => n,Macro(say,to-access-your-multnomah-county-library-account)
same => n,Macro(say,press-three)
same => n,Macro(say,for-a-random-number)
same => n,Macro(say,press-five)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(current-time,s,1)
exten => 2,1,Goto(trimet-transit-tracker,s,1)
exten => 3,1,Goto(lib-account-line,s,1)
exten => 5,1,Goto(random-number,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[utilities-ivr-ypsi]
exten => s,1,Macro(metric,utilities-ivr-ypsi)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-current-time)
same => n,Macro(say,press-one)
same => n,Macro(say,for-a-random-number)
same => n,Macro(say,press-five)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(current-time-ypsi,s,1)
exten => 5,1,Goto(random-number,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

; directory
[mayor-vm]
    exten => s,1,Macro(metric,mayor-vm)
    same => n,Macro(dial,+15038234120)

[apology-line]
    exten => s,1,Macro(metric,apology-line)
    same => n,Macro(dial,+13472012446)

[record]
    exten => s,1,Macro(metric,record)
    same => n,AGI(record.agi)

[trimet-transit-tracker]
    exten => s,1,Macro(metric,trimet-transit-tracker)
    same => n,Macro(dial,+15032387433)

[lib-account-line]
    exten => s,1,Macro(metric,lib-account-line)
    same => n,Macro(dial,+15039885342)

[cnet-portal]
    exten => s,1,Macro(metric,cnet-portal)
    same => n,Macro(dial,+19149401363)

; call "payphone shotgun" using queue
[random-payphone]
exten => s,1,Macro(metric,random-payphone)
same => n,Queue(payphones,r)

; get random destination from script and call it
[dark-fiber]
exten => s,1,Macro(metric,dark-fiber)
same => n,AGI(dark_fiber.agi)
same => n,Macro(dial,${agi_out})

[lance-e-pants]
    exten => s,1,Macro(metric,lance-e-pants)
    same => n,Macro(dial,${e_pants})

[current-time]
    exten => s,1,Macro(metric,current-time)
    same => n,SayUnixTime()

[current-time-ypsi]
    exten => s,1,Macro(metric,current-time-ypsi)
    same => n,SayUnixTime(,EST5EDT)

[info-211]
    exten => s,1,Macro(metric,info-211)
    same => n,Macro(dial,+18666986155)

[dream-survey]
    exten => s,1,Macro(metric,dream-survey)
    same => n,Macro(dial,+19712581465)

[office-of-night-things]
    exten => s,1,Macro(metric,office-of-night-things)
    same => n,Macro(dial,+18003900934)

[beyond-the-echo]
    exten => s,1,Macro(metric,beyond-the-echo)
    same => n,Macro(dial,+12703015797)

[random-number]
; read back a random number to the caller
exten => s,1,Macro(metric,random-number)
same => n(random-number),NoOp
same => n,set(current=${RAND(0,99)})
same => n,Macro(say,your-random-number-is)
same => n(current-number),NoOp
same => n,SayNumber(${current})
same => n(postsetup),NoOp
same => n,Macro(say,to-hear-number-again)
same => n,Macro(say,press-one)
same => n,Macro(say,for-a-random-number)
same => n,Macro(say,press-two)
same => n,WaitExten(0.5)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(s,current-number)
exten => 2,1,Goto(s,random-number)
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[futel-conf]
    ; incoming ConfBridge
    exten => s,1,Macro(metric,futel-conf)
    same => n,ConfBridge(666,futel_conf,futel_conf_user,futel_conf_menu)

[mojave-conference]
exten => s,1,Macro(metric,mojave-conference)
same => n,Macro(dial,+17607339969)

[mental-health-crisis]
exten => s,1,Macro(metric,mental-health-crisis)
same => n,Macro(dial,+15039884888)

[call-to-safety]
; https://calltosafety.org/
exten => s,1,Macro(metric,call-to-safety)
same => n,Macro(dial,+15032355333)

[operator]
exten => s,1,Macro(metric,operator)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,UserEvent(OperatorAttempt)
same => n,Macro(say,please-hold)
same => n,Macro(say,for-the-next-available-operator)
same => n,FollowMe(operator,d)
; if we got here, no operator accepted
same => n,Macro(metric,operator-nopickup)
same => n,UserEvent(OperatorNoPickup)
same => n,VoiceMail(1337,u)
; on invalid repeat, this at least lets panicky users think about what
; they're doing during the intro statements
exten => i,1,Goto(s,postsetup)

; submenu to call out from a conference
; XXX this is an unfiltered DID
; [add-futel-conf]
;     exten => s,1,Macro(metric,add-futel-conf)
;     ; read a phone number from user and store it in ${did}
;     same => n,Read(did,,11)
;     ; TODO use ${outgoing_channel} for the sip trunk
;     same => n,Originate(SIP/callcentric-tishbite/${did},exten,futel-conf)

[wildcard-line-outgoing]
exten => s,1,Macro(metric,wildcard-line-outgoing)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Macro(say,wildcard-line-welcome,wildcard-line)
same => n,Macro(say,wildcard-line-to-contribute,wildcard-line)
same => n,Macro(say,wildcard-line-press-one,wildcard-line)
same => n,Macro(say,wildcard-line-to-hear,wildcard-line)
same => n,Macro(say,wildcard-line-episode-three,wildcard-line)
same => n,Macro(say,wildcard-line-press-two,wildcard-line)
same => n,Macro(say,wildcard-line-to-hear,wildcard-line)
same => n,Macro(say,wildcard-line-episode-two,wildcard-line)
same => n,Macro(say,wildcard-line-press-three,wildcard-line)
same => n,Macro(say,wildcard-line-to-hear,wildcard-line)
same => n,Macro(say,wildcard-line-episode-one,wildcard-line)
same => n,Macro(say,wildcard-line-press-four,wildcard-line)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Gosub(wildcard-line-contribute,s,1)
exten => 2,1,Gosub(wildcard-line-play-3,s,1)
exten => 3,1,Gosub(wildcard-line-play-2,s,1)
exten => 4,1,Gosub(wildcard-line-play-1,s,1)
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[wildcard-line-incoming]
exten => s,1,Macro(metric,wildcard-line)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Macro(say,wildcard-line-welcome,wildcard-line)
same => n,Macro(say,wildcard-line-to-hear,wildcard-line)
same => n,Macro(say,wildcard-line-episode-three,wildcard-line)
same => n,Macro(say,wildcard-line-press-one,wildcard-line)
same => n,Macro(say,wildcard-line-to-hear,wildcard-line)
same => n,Macro(say,wildcard-line-episode-two,wildcard-line)
same => n,Macro(say,wildcard-line-press-two,wildcard-line)
same => n,Macro(say,wildcard-line-to-hear,wildcard-line)
same => n,Macro(say,wildcard-line-episode-one,wildcard-line)
same => n,Macro(say,wildcard-line-press-three,wildcard-line)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Gosub(wildcard-line-play-3,s,1)
exten => 2,1,Gosub(wildcard-line-play-2,s,1)
exten => 3,1,Gosub(wildcard-line-play-1,s,1)
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[wildcard-line-contribute]
exten => s,1,Macro(metric,wildcard-line-contribute)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Macro(say,wildcard-line-welcome,wildcard-line)
same => n,Macro(say,wildcard-line-leave-message,wildcard-line)
same => n,VoiceMail(1337,s)
same => n,Macro(say,wildcard-line-thank-you,wildcard-line)
same => n,Macro(say,wildcard-line-come-back,wildcard-line)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[wildcard-line-play-1]
exten => s,1,Macro(metric,wildcard-line-play-1)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,MP3Player(/usr/share/asterisk/sounds/futel/wildcard-line/1.mp3)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[wildcard-line-play-2]
exten => s,1,Macro(metric,wildcard-line-play-2)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,MP3Player(/usr/share/asterisk/sounds/futel/wildcard-line/2.mp3)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[wildcard-line-play-3]
exten => s,1,Macro(metric,wildcard-line-play-3)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,MP3Player(/usr/share/asterisk/sounds/futel/wildcard-line/3.mp3)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[robotron]
exten => s,1,Macro(metric,robotron)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-doctrine-of-futility,robotron)
same => n,Macro(say,press-one,robotron)
same => n,Macro(say,for-the-eight-ways,robotron)
same => n,Macro(say,press-two,robotron)
same => n,Macro(say,for-the-doctrine-of-error,robotron)
same => n,Macro(say,press-three,robotron)
same => n,Macro(say,for-the-ninth-position,robotron)
same => n,Macro(say,press-four,robotron)
same => n,Macro(say,for-what-are-the-robotrons,robotron)
same => n,Macro(say,press-five,robotron)
same => n,Macro(say,for-robotron-battle-poetry,robotron)
same => n,Macro(say,press-six,robotron)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Gosub(robotron-doctrine-of-futility-play,s,1)
same => n,Goto(s,postsetup)
exten => 2,1,Gosub(robotron-eight-ways-play,s,1)
same => n,Goto(s,postsetup)
exten => 3,1,Gosub(robotron-doctrine-of-error-play,s,1)
same => n,Goto(s,postsetup)
exten => 4,1,Goto(robotron-ninth-position-play,s,1)
same => n,Goto(s,postsetup)
exten => 5,1,Goto(robotron-what-are-the-robotrons-play,s,1)
same => n,Goto(s,postsetup)
exten => 6,1,Gosub(robotron-battle-poetry-play,s,1)
same => n,Goto(s,postsetup)
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[robotron-doctrine-of-futility-play]
exten => s,1,Macro(metric,robotron-doctrine-of-futility-play)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,MP3Player(/usr/share/asterisk/sounds/futel/robotron/Church_of_Robotron_Sermon__Doctrine_of_Futility.mp3)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[robotron-eight-ways-play]
exten => s,1,Macro(metric,robotron-eight-ways-play)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,MP3Player(/usr/share/asterisk/sounds/futel/robotron/Church_of_Robotron_Sermon__Eight_Ways.mp3)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[robotron-doctrine-of-error-play]
exten => s,1,Macro(metric,robotron-doctrine-of-error-play)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,MP3Player(/usr/share/asterisk/sounds/futel/robotron/Church_of_Robotron_Sermon__Doctrine_of_Error.mp3)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[robotron-ninth-position-play]
exten => s,1,Macro(metric,robotron-ninth-position-play)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,MP3Player(/usr/share/asterisk/sounds/futel/robotron/Church_of_Robotron_Sermon__The_Ninth_Position.mp3)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[robotron-what-are-the-robotrons-play]
exten => s,1,Macro(metric,robotron-what-are-the-robotrons-play)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,MP3Player(/usr/share/asterisk/sounds/futel/robotron/Church_of_Robotron_Sermon__What_are_the_Robotrons.mp3)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[robotron-battle-poetry-play]
exten => s,1,Macro(metric,robotron-battle-poetry-play)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,MP3Player(/usr/share/asterisk/sounds/futel/robotron/waves.mp3)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[oracle-dead]
exten => s,1,Macro(metric,oracle-dead)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.25)
same => n,Gosub(oracle-dead-intro,s,1)
same => n,Gosub(oracle-dead-instructions,s,1)
same => n,Gosub(oracle-dead-entry,s,1)
same => n,Gosub(oracle-dead-setup,s,1)
same => n,Gosub(oracle-dead-sound-intro,s,1)
same => n,Gosub(oracle-dead-sound,s,1)
same => n,Gosub(oracle-dead-debrief,s,1)
same => n,Macro(say,oracle-dead-thank-you-for-using-fewtel,oracle-dead)
same => n,Hangup
; On invalid repreat at beginning, in case a mashed key leaks through to
; this menu. This is nonoptimal, but better than ending the call.
exten => i,1,Goto(s,postsetup)

[oracle-dead-intro]
exten => s,1,NoOp
same => n,AGI(random_file.agi,/usr/share/asterisk/sounds/futel/oracle-dead-interstitial-long)
same => n,Playback(${agi_out})
same => n,Macro(say,oracle-dead-intro-hello,oracle-dead)
same => n,Macro(say,oracle-dead-intro-to-skip-instructions,oracle-dead)
same => n,Macro(say,oracle-dead-intro-motivation,oracle-dead)
same => n,Macro(say,oracle-dead-intro-no-guarantee-content,oracle-dead)
same => n,Macro(say,press-any-key-to-continue,oracle-dead)
same => n,WaitExten(15)
same => n,Return
; skip instructions on any key
exten => i,1,Return

[oracle-dead-instructions]
exten => s,1,NoOp
same => n,Macro(say,oracle-dead-instructions-enter-numbers,oracle-dead)
;same => n,Macro(say,oracle-dead-intro-to-skip-instructions,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-numbers-details,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-numbers-examples,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-numbers-many,oracle-dead)
;same => n,Macro(say,oracle-dead-instructions-enter-numbers-star,oracle-dead)
same => n,Macro(say,press-any-key-to-continue,oracle-dead)
same => n,WaitExten(15)
same => n,Return
; skip instructions on any key
exten => i,1,Return

[oracle-dead-entry]
exten => s,1,NoOp
same => n,Macro(setup-iteration)
same => n,Set(numbers=0)
same => n(postsetup),NoOp
same => n,Macro(say,oracle-dead-instructions-enter-number,oracle-dead)
same => n,Macro(iterate-guard)
same => n(digit),WaitExten(10)
same => n,Goto(s,postsetup) ; on timeout, prompt from the start again
; on any digit except * or #, collect another digit
exten => i,1,NoOp
same => n,Goto(s,digit)  ; collect another digit
exten => #,1,NoOp
same => n,Set(numbers=$[${numbers} + 1])
same => n,AGI(random_file.agi,/usr/share/asterisk/sounds/futel/oracle-dead-interstitial-short)
same => n,Playback(${agi_out})
same => n,Macro(say,thank-you,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-number-again,oracle-dead)
same => n,Goto(s,digit)         ; collect another
exten => *,1,NoOp
; if 3 or more entered, done, else nag
same => n,gotoIf($[${numbers} > 2]?done)
same => n,Macro(say,oracle-dead-instructions-enter-numbers-more,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-numbers-why,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-number,oracle-dead)
same => n,Goto(s,digit)
same => n(done),NoOp
same => n,Macro(say,oracle-dead-thank-you-for-using-fewtel,oracle-dead)
same => n,Return

[oracle-dead-setup]
exten => s,1,NoOp
same => n,Macro(say,oracle-dead-instructions-when-ready,oracle-dead)
same => n,WaitExten(15)
same => n,Return
exten => i,1,Return

[oracle-dead-sound-intro]
exten => s,1,NoOp
same => n,AGI(random_file.agi,/usr/share/asterisk/sounds/futel/oracle-dead-interstitial-long)
same => n,Playback(${agi_out})
same => n,Macro(say,oracle-dead-setup-attempting,oracle-dead)
same => n,Macro(say,oracle-dead-intro-no-guarantee-recipient,oracle-dead)
same => n,Macro(say,oracle-dead-setup-to-relinquish,oracle-dead)
same => n,Return
exten => i,1,Return

[oracle-dead-sound]
exten => s,1,NoOp
same => n,AGI(random_file.agi,/usr/share/asterisk/sounds/futel/oracle-dead-oracle)
same => n,Background(${agi_out})
same => n,Return
exten => i,1,Return

[oracle-dead-debrief]
exten => s,1,NoOp
same => n,Macro(say,oracle-dead-thank-you-for-using-fewtel,oracle-dead)
same => n,Macro(say,oracle-dead-debrief-to-share,oracle-dead)
same => n,Macro(say,oracle-dead-debrief-otherwise,oracle-dead)
same => n,WaitExten(30)
same => n,Return
;exten => #,1,Macro(say,oracle-dead-debrief-record,oracle-dead)
exten => #,1,VoiceMail(1340,u)
same => n,Return
exten => i,1,Return

#include extensions_secret.conf
